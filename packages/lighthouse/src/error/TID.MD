## ğŸ“Œ ä¸€ã€ç›®æ ‡

* æµè§ˆå™¨é”™è¯¯æ•è·æœºåˆ¶ï¼ˆåŒæ­¥ JS é”™è¯¯ã€æœªå¤„ç† Promiseï¼‰
* AOP æŠ€æœ¯åŠ«æŒåŸç”Ÿ API (`XMLHttpRequest`ã€`fetch`) åšç½‘ç»œé”™è¯¯ç›‘æ§
* èµ„æºåŠ è½½é”™è¯¯ç›‘æ§ï¼ˆå¦‚å›¾ç‰‡ã€è„šæœ¬ç­‰ï¼‰
* é”™è¯¯æ•°æ®å¯é ä¸ŠæŠ¥ç­–ç•¥ï¼ˆä¼˜å…ˆä½¿ç”¨ `sendBeacon`ï¼‰ ([CodeLove][2])

---

## ğŸ—ï¸ äºŒã€SDK è®¾è®¡æ¶æ„

æ•´ä½“åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š

````
ç›‘æ§å…¥å£
â”œâ”€ é”™è¯¯æ•è·
â”œâ”€ ç½‘ç»œç›‘æ§
â”œâ”€ èµ„æºç›‘æ§
â””â”€ ä¸ŠæŠ¥æ¨¡å—
``` :contentReference[oaicite:3]{index=3}

---

## ğŸ“ ä¸‰ã€æ ¸å¿ƒåŸç†ä¸å®ç°

---

### ğŸ§© 3.1 åˆå§‹åŒ–å…¥å£

åœ¨å…¥å£æ–‡ä»¶åˆå§‹åŒ–å„æ¨¡å—ï¼š

```ts
import { monitorJavaScriptErrors } from './errorHandler';
import { monitorNetworkErrors } from './networkMonitor';
import { monitorResourceErrors } from './resourceMonitor';

export const initErrorMonitor = (config) => {
  const { reportUrl, projectName, environment } = config;

  monitorJavaScriptErrors(reportUrl, projectName, environment);
  monitorNetworkErrors(reportUrl, projectName, environment);
  monitorResourceErrors(reportUrl, projectName, environment);
};
````

---

### ğŸ›‘ 3.2 JavaScript é”™è¯¯æ•è·

æ•è·åŒæ­¥é”™è¯¯ä¸æœªå¤„ç† Promiseï¼š

* `window.onerror`ï¼šæ•è·åŒæ­¥è„šæœ¬é”™è¯¯
* `window.onunhandledrejection`ï¼šæ•è·æœªå¤„ç†çš„ Promise å¼‚å¸¸

```ts
const originalOnError = window.onerror;
window.onerror = (message, source, lineno, colno, error) => {
  sendErrorData({...}, reportUrl);
  originalOnError?.(message, source, lineno, colno, error);
};
```

---

### ğŸŒ 3.3 ç½‘ç»œè¯·æ±‚ç›‘æ§

åŠ«æŒåŸç”Ÿç½‘ç»œ APIï¼š

#### ğŸ”¹ XMLHttpRequest

```ts
const originalXhrOpen = XMLHttpRequest.prototype.open;
XMLHttpRequest.prototype.open = function (method, url, ...args) {
  this.addEventListener('error', () => {
    sendErrorData({...}, reportUrl);
  });
  return originalXhrOpen.apply(this, [method, url, ...args]);
};
```

#### ğŸ”¹ fetch

```ts
const originalFetch = window.fetch;
window.fetch = async (input, init) => {
  const response = await originalFetch(input, init);
  if (!response.ok) {
    sendErrorData({...}, reportUrl);
  }
  return response;
};
```

---

### ğŸ–¼ï¸ 3.4 èµ„æºåŠ è½½é”™è¯¯ç›‘æ§

èµ„æºåŠ è½½é”™è¯¯ä¸ä¼šå†’æ³¡ï¼Œéœ€è¦åœ¨æ•è·é˜¶æ®µç›‘å¬ï¼š

```ts
window.addEventListener(
  'error',
  (event) => {
    const target = event.target;
    if (target.tagName === 'IMG' || target.tagName === 'SCRIPT') {
      sendErrorData({...}, reportUrl);
    }
  },
  true
);
```

---

### ğŸ“¡ 3.5 æ•°æ®ä¸ŠæŠ¥ç­–ç•¥

ä¸ºäº†ä¿è¯åœ¨é¡µé¢å¸è½½æ—¶ä¹Ÿèƒ½ä¸ŠæŠ¥ï¼š

#### âœ” ä½¿ç”¨ Navigator.sendBeacon

ä¼˜ç‚¹ï¼š

* ä¸é˜»å¡é¡µé¢è·³è½¬
* æµè§ˆå™¨ä¿è¯å‘é€

```ts
if (navigator.sendBeacon) {
  navigator.sendBeacon(reportUrl, blob);
} else {
  fetch(reportUrl, {...});
}
```